## 経費精算システム 完全実装計画書（最終版）

### 1. システム概要

**目的：**
金融系システムの実践的な学習を通じて、DDD/クリーンアーキテクチャ、マイクロサービス、BFF、CI/CDを習得する

**学習期間：** 6ヶ月（ローカル3ヶ月 → AWS 3ヶ月）

### 2. 機能要件詳細

#### 2.1 バックエンド機能一覧

##### 認証サービス (auth-service)
```yaml
認証・認可:
  - ユーザー登録（メール認証付き）
  - ログイン（JWT発行）
  - ログアウト（トークン無効化）
  - パスワードリセット（メール送信）
  - リフレッシュトークン処理
  - 多要素認証（TOTP）

ユーザー管理:
  - プロフィール取得・更新
  - アバター画像アップロード
  - 部署・役職管理
  - 権限管理（RBAC）

セッション管理:
  - アクティブセッション一覧
  - 強制ログアウト
  - ログイン履歴
  - 不正アクセス検知
```

##### 経費サービス (expense-service)
```yaml
経費申請管理:
  - 申請CRUD操作
  - 下書き保存・自動保存
  - テンプレート機能
  - 一括申請
  - 申請のコピー作成
  - 定期申請（交通費等）

領収書管理:
  - ファイルアップロード（画像/PDF）
  - OCR処理（外部API連携想定）
  - サムネイル生成
  - ファイル検証（サイズ、形式）
  - 複数ファイル一括アップロード

カテゴリ・経費項目:
  - カテゴリマスタ管理
  - 経費項目設定
  - 勘定科目マッピング
  - カスタムカテゴリ作成

検索・フィルタリング:
  - 期間指定検索
  - ステータス別フィルタ
  - 金額範囲検索
  - 全文検索
  - 高度な検索条件の保存

集計・分析:
  - 月次/四半期/年次集計
  - カテゴリ別集計
  - 部門別集計
  - 前期比較
  - トレンド分析

インポート・エクスポート:
  - CSV/Excelインポート
  - PDFレポート生成
  - 請求書フォーマット出力
  - 会計システム連携用データ出力
```

##### ワークフローサービス (workflow-service)
```yaml
承認フロー管理:
  - 承認ルート定義（条件分岐）
  - 多段階承認（最大5段階）
  - 並列承認
  - 条件付き自動承認
  - エスカレーション

承認アクション:
  - 承認実行
  - 却下（理由必須）
  - 差戻し（修正依頼）
  - 条件付き承認
  - 一括承認
  - 承認の取り消し

代理機能:
  - 代理承認者設定
  - 期間指定代理
  - 自動転送設定
  - 代理承認ログ

通知制御:
  - 承認依頼通知
  - リマインダー（未承認アラート）
  - エスカレーション通知
  - 期限切れアラート
  - カスタム通知ルール

ワークフロー分析:
  - 承認時間分析
  - ボトルネック検出
  - 承認率統計
  - 滞留案件レポート
```

##### 予算サービス (budget-service)
```yaml
予算管理:
  - 年度予算設定
  - 四半期・月次配分
  - 部門別予算割当
  - プロジェクト別予算
  - 予算改定履歴

予算監視:
  - リアルタイム消化率計算
  - 閾値アラート（50%, 80%, 100%）
  - 予測分析（現在のペースでの着地予測）
  - 異常検知

予算制御:
  - 予算超過防止（申請ブロック）
  - 仮押さえ機能
  - 予算振替
  - 緊急予算申請

レポーティング:
  - 予算実績対比表
  - 部門別消化状況
  - 予算推移グラフ
  - 予実差異分析
```

##### 通知サービス (notification-service)
```yaml
通知配信:
  - メール通知（SendGrid/SES連携）
  - Slack通知
  - Teams通知
  - アプリ内通知
  - SMS通知（オプション）

通知管理:
  - テンプレート管理
  - 配信スケジューリング
  - 一括配信
  - 配信履歴
  - 配信失敗時のリトライ

購読管理:
  - 通知設定（ユーザー別）
  - 通知種別のON/OFF
  - 配信時間帯設定
  - ダイジェスト設定
```

##### 監査サービス (audit-service)
```yaml
監査ログ:
  - 全操作ログ記録
  - データ変更履歴
  - アクセスログ
  - エラーログ
  - セキュリティイベント

イベントソーシング:
  - ドメインイベント記録
  - イベント再生
  - スナップショット管理
  - イベントストリーム購読

コンプライアンス:
  - データ保持ポリシー
  - 個人情報アクセス記録
  - 不正検知
  - 監査レポート生成
  - 電子帳簿保存法対応
```

##### BFFサービス (bff-service)
```yaml
API集約:
  - GraphQL対応（将来オプション）
  - レスポンス整形
  - フィールド選択
  - バッチリクエスト
  - データ結合

認証ゲートウェイ:
  - トークン検証
  - セッション管理
  - レート制限
  - CORS制御
  - APIキー管理

キャッシュ管理:
  - Redis連携
  - キャッシュ戦略（TTL設定）
  - キャッシュ無効化
  - CDNキャッシュ制御

WebSocket管理:
  - コネクション管理
  - ルーム機能
  - プレゼンス機能
  - 再接続処理
  - ハートビート

ファイル処理:
  - マルチパートアップロード
  - 画像リサイズ
  - ファイル検証
  - ウイルススキャン（オプション）
  - S3直接アップロード用の署名付きURL生成
```

#### 2.2 フロントエンド機能一覧

##### 認証関連画面
```yaml
公開画面:
  - ログイン画面
    * メールアドレス/パスワード入力
    * 多要素認証（OTP入力）
    * ソーシャルログイン（オプション）
    * Remember Me機能

  - パスワードリセット画面
    * メールアドレス入力
    * リセットトークン確認
    * 新パスワード設定

  - ユーザー登録画面（管理者用）
    * 基本情報入力
    * 部署・役職選択
    * 権限設定

セキュリティ画面:
  - 二要素認証設定画面
    * QRコード表示
    * バックアップコード生成
    * 認証アプリ連携
```

##### 申請者向け画面
```yaml
ダッシュボード:
  - サマリーウィジェット
    * 今月の申請金額
    * 承認待ち件数
    * 却下/差戻し件数
    * 直近の申請状況

  - 申請一覧
    * ページネーション
    * ソート機能（日付、金額、ステータス）
    * フィルター（期間、ステータス、カテゴリ）
    * 一括選択・操作

  - カレンダービュー
    * 月次表示
    * 申請締切日表示
    * ドラッグ&ドロップ

経費申請作成:
  - 基本情報入力フォーム
    * 日付ピッカー
    * カテゴリ選択（階層型）
    * 金額入力（通貨フォーマット）
    * 支払方法選択

  - 明細入力
    * 明細行の動的追加/削除
    * 小計自動計算
    * 税額計算
    * テンプレート適用

  - 領収書アップロード
    * ドラッグ&ドロップ
    * 複数ファイル対応
    * プレビュー機能
    * OCR結果確認・修正

  - 確認画面
    * 入力内容確認
    * 承認フロー表示
    * 提出前チェックリスト

申請詳細・編集:
  - 詳細表示
    * 申請情報表示
    * 承認履歴タイムライン
    * コメント表示
    * 添付ファイルビューア

  - 編集機能
    * インライン編集
    * 自動保存
    * 変更履歴表示
    * 差分表示

申請履歴:
  - 検索機能
    * 詳細検索フォーム
    * 検索条件保存
    * 検索履歴

  - エクスポート
    * CSV/Excel出力
    * PDF生成
    * 印刷プレビュー
```

##### 承認者向け画面
```yaml
承認ダッシュボード:
  - 承認待ちサマリー
    * 件数バッジ
    * 金額合計
    * 優先度表示
    * 期限アラート

  - 承認待ち一覧
    * クイックアクション
    * 一括承認
    * フィルター（申請者、金額範囲）
    * グループ化表示

承認詳細画面:
  - 申請内容確認
    * 前回申請との比較
    * 関連申請表示
    * 予算消化状況

  - 承認アクション
    * 承認ボタン
    * 却下（理由入力必須）
    * 差戻し（コメント付き）
    * 条件付き承認

  - コメント機能
    * リアルタイムコメント
    * メンション機能
    * ファイル添付

承認履歴:
  - 履歴一覧
    * タイムライン表示
    * フィルター（期間、アクション種別）
    * 統計情報表示

代理設定:
  - 代理承認者設定
    * 期間設定カレンダー
    * 承認者検索・選択
    * 権限範囲設定

  - 代理履歴
    * 代理承認ログ
    * 期間別集計
```

##### 管理者向け画面
```yaml
ユーザー管理:
  - ユーザー一覧
    * 検索・フィルター
    * 一括操作
    * インポート/エクスポート

  - ユーザー詳細
    * プロフィール編集
    * 権限設定
    * 所属変更
    * アカウント停止/削除

組織管理:
  - 部署管理
    * ツリー表示
    * ドラッグ&ドロップ編集
    * 部署別予算設定

  - 役職管理
    * 承認権限設定
    * 承認限度額設定

承認ルール設定:
  - ルール一覧
    * 有効/無効切り替え
    * 優先度設定
    * ドラッグ&ドロップ並び替え

  - ルールビルダー
    * 条件設定UI
    * プレビュー機能
    * テスト実行

予算管理:
  - 予算設定
    * 年度予算入力
    * 配分設定（グラフ表示）
    * シミュレーション

  - 予算モニタリング
    * ダッシュボード
    * リアルタイムグラフ
    * アラート設定
    * 予測表示

マスタ管理:
  - カテゴリ管理
    * 階層編集
    * アイコン設定
    * 有効期限設定

  - 勘定科目設定
    * マッピング設定
    * 会計システム連携

監査ログ:
  - ログ検索
    * 詳細フィルター
    * 時系列表示
    * エクスポート

  - 異常検知
    * アラート一覧
    * 調査ツール
```

##### 共通コンポーネント
```yaml
UIコンポーネント:
  - ヘッダー
    * ロゴ・ナビゲーション
    * 通知ベル（未読バッジ）
    * ユーザーメニュー
    * 検索バー

  - サイドバー
    * メニュー（アコーディオン）
    * お気に入り
    * 最近のアクセス

  - 通知センター
    * 通知一覧
    * 既読管理
    * フィルター
    * 設定リンク

  - モーダル/ダイアログ
    * 確認ダイアログ
    * フォームモーダル
    * 画像ビューア
    * エラーダイアログ

  - フォーム部品
    * 入力検証
    * エラー表示
    * ヘルプツールチップ
    * 入力補助

  - テーブル
    * ソート機能
    * カラム表示/非表示
    * 固定ヘッダー
    * 無限スクロール

  - グラフ/チャート
    * 折れ線グラフ
    * 棒グラフ
    * 円グラフ
    * ヒートマップ

レスポンシブ対応:
  - モバイルビュー
    * タッチ操作最適化
    * スワイプ操作
    * プルリフレッシュ

  - タブレットビュー
    * 分割ビュー
    * ポップオーバー

アクセシビリティ:
  - キーボード操作
  - スクリーンリーダー対応
  - ハイコントラストモード
  - フォントサイズ調整
```

### 3. アーキテクチャ設計

#### 3.1 マイクロサービスアーキテクチャ

```yaml
サービス分割戦略:
  原則:
    - 単一責任の原則
    - データベース per サービス（論理分離）
    - 非同期通信優先
    - サービス間の疎結合

  サービス間通信:
    同期: gRPC（内部通信）
    非同期: イベント駆動（Redis Pub/Sub → AWS SQS/SNS）

  サービスディスカバリ:
    ローカル: Docker Compose内部DNS
    AWS: ECS Service Discovery / Cloud Map
```

#### 3.2 各サービスのクリーンアーキテクチャ

```yaml
レイヤー構造（全サービス共通）:

  ├── domain/              # エンタープライズビジネスルール
  │   ├── entity/         # エンティティ
  │   ├── value_object/   # 値オブジェクト
  │   └── repository/     # リポジトリインターフェース
  │
  ├── usecase/            # アプリケーションビジネスルール
  │   ├── interactor/     # ユースケース実装
  │   ├── port/          # 入出力ポート定義
  │   └── dto/           # データ転送オブジェクト
  │
  ├── adapter/            # インターフェースアダプター
  │   ├── controller/     # HTTPハンドラー
  │   ├── presenter/      # レスポンス整形
  │   ├── gateway/        # 外部サービス連携
  │   └── repository/     # リポジトリ実装
  │
  └── infrastructure/     # フレームワーク＆ドライバー
      ├── database/       # DB接続
      ├── server/         # HTTPサーバー
      ├── config/         # 設定
      └── middleware/     # ミドルウェア

依存性の方向:
  外側 → 内側のみ（依存性逆転の原則）
  infrastructure → adapter → usecase → domain
```

### 4. データベース設計

```yaml
PostgreSQL スキーマ分離:
  auth_schema:
    - users
    - sessions
    - refresh_tokens
    - login_history

  expense_schema:
    - expenses
    - expense_items
    - receipts
    - categories
    - templates

  workflow_schema:
    - workflows
    - workflow_definitions
    - approval_steps
    - approval_history
    - delegation_rules

  budget_schema:
    - budgets
    - budget_allocations
    - budget_consumption
    - budget_alerts

  audit_schema:
    - events
    - audit_logs
    - snapshots
```

### 5. インフラストラクチャ（Terraform）

```hcl
# modules/microservice/main.tf
module "microservice" {
  source = "./modules/microservice"

  for_each = {
    auth     = { port = 8001, cpu = 256, memory = 512 }
    expense  = { port = 8002, cpu = 256, memory = 512 }
    workflow = { port = 8003, cpu = 256, memory = 512 }
    budget   = { port = 8004, cpu = 256, memory = 512 }
    bff      = { port = 8000, cpu = 512, memory = 1024 }
  }

  name        = each.key
  port        = each.value.port
  cpu         = each.value.cpu
  memory      = each.value.memory
  environment = var.environment
}

# RDS PostgreSQL
resource "aws_db_instance" "postgres" {
  engine         = "postgres"
  engine_version = "15.4"
  instance_class = "db.t3.micro"

  # スキーマは初期化スクリプトで作成
}

# API Gateway WebSocket
resource "aws_apigatewayv2_api" "websocket" {
  name                       = "expense-notifications"
  protocol_type             = "WEBSOCKET"
  route_selection_expression = "$request.body.action"
}
```

### 6. CI/CD パイプライン

```yaml
# .github/workflows/main.yml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth, expense, workflow, budget, bff]

    steps:
      - name: Test
        run: |
          cd services/${{ matrix.service }}
          go test -v -cover ./...

  build-and-deploy:
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Build Docker Images
        run: |
          docker build -t $SERVICE:$GITHUB_SHA .

      - name: Deploy to ECS (Blue/Green)
        run: |
          aws ecs update-service \
            --cluster main-cluster \
            --service $SERVICE \
            --task-definition $SERVICE:$GITHUB_SHA
```

### 7. 開発スケジュール

```yaml
Month 1 - 基盤構築:
  Week 1-2:
    Backend:
      - クリーンアーキテクチャのテンプレート作成
      - 認証サービス（ログイン、JWT、セッション管理）
      - ユーザー管理API
    Frontend:
      - Next.js プロジェクトセットアップ
      - 認証フロー実装（ログイン、ログアウト）
      - レイアウトコンポーネント

  Week 3-4:
    Backend:
      - BFF基盤（API集約、WebSocket）
      - 認証サービス完成（MFA、パスワードリセット）
    Frontend:
      - ダッシュボード画面
      - 通知コンポーネント
      - 共通UIコンポーネント

Month 2 - コア機能実装:
  Week 1-2:
    Backend:
      - 経費サービス（CRUD、検索、集計）
      - ファイルアップロード機能
      - DDD実装（集約、イベント）
    Frontend:
      - 経費申請作成画面
      - 申請一覧・検索画面
      - ファイルアップロードUI

  Week 3-4:
    Backend:
      - ワークフローサービス（承認フロー、Saga）
      - 通知サービス基盤
    Frontend:
      - 承認画面群
      - 承認フロー可視化
      - リアルタイム通知

Month 3 - 機能完成・テスト:
  Week 1-2:
    Backend:
      - 予算サービス
      - 監査サービス（イベントソーシング）
      - バッチ処理
    Frontend:
      - 管理画面（ユーザー、組織、ルール）
      - 予算管理画面
      - レポート画面

  Week 3-4:
    Backend:
      - 統合テスト
      - パフォーマンステスト
    Frontend:
      - E2Eテスト（Playwright）
      - レスポンシブ対応
    Infrastructure:
      - Terraform作成
      - Docker最適化

Month 4 - AWS移行準備:
  Week 1-2:
    - AWSアカウント作成（Free Plan）
    - アクティビティ完了（$200クレジット獲得）
    - Terraform実行（dev環境）

  Week 3-4:
    - GitHub Actions設定
    - 環境変数移行（Systems Manager）
    - セキュリティ設定

Month 5 - AWS展開:
  Week 1-2:
    - ECSへの全サービスデプロイ
    - RDS設定・データ移行
    - S3 + CloudFront（フロントエンド）

  Week 3-4:
    - API Gateway WebSocket設定
    - Lambda関数デプロイ
    - 監視設定（CloudWatch）

Month 6 - 本番運用レベル:
  Week 1-2:
    - Blue/Greenデプロイ実装
    - カナリアリリース設定
    - オートスケーリング設定

  Week 3-4:
    - 負荷テスト
    - セキュリティ監査
    - ドキュメント完成
```

### 8. 成功指標

```yaml
機能完成度:
  Backend:
    - 全API実装完了: 100%
    - テストカバレッジ: 80%以上
    - パフォーマンス: レスポンス500ms以内

  Frontend:
    - 全画面実装完了: 100%
    - Lighthouse Score: 90以上
    - アクセシビリティ: WCAG 2.1 AA準拠

技術習得:
  - クリーンアーキテクチャの全レイヤー実装
  - DDDの戦術的パターン実践
  - マイクロサービス間通信の実装
  - IaCによる完全自動化

運用指標:
  - Blue/Greenデプロイ: ダウンタイム0
  - 監視: 全サービスのメトリクス取得
  - コスト: $200クレジット内
  - CI/CD: コミットから本番まで15分以内
```

### 9. リスクと対策

```yaml
技術的リスク:
  - マイクロサービス間の複雑性
    → 段階的に分割、最初はモノリスから開始

  - パフォーマンス問題
    → 早期からプロファイリング、キャッシュ戦略

  - AWSコスト超過
    → 予算アラート設定、使用量の日次確認

スケジュールリスク:
  - 機能過多による遅延
    → MVP定義、優先順位付け

  - 学習曲線
    → 各技術のチュートリアル期間確保
```

この包括的な計画で進めていいか？
