# enterprise-expense-system - 要件定義書

## 1. プロジェクト概要

### 1.1 目的・背景

**学習目的：**
- 金融系システムの実践的な学習を通じて、DDD/クリーンアーキテクチャ、マイクロサービス、BFF、CI/CDを習得する
- エンタープライズレベルの経費精算システムを通じて、現代的なソフトウェア開発手法を学ぶ

**解決したい課題：**
- 複雑なビジネスロジックを持つシステムでのDDD実践
- マイクロサービス間の通信・データ整合性管理
- リアルタイム通知・承認フローの実装
- 大規模システムのテスト戦略とCI/CD

**ステークホルダー：**
- 開発者（学習者）：システム全体の設計・実装・運用を担当
- 想定ユーザー：申請者、承認者、管理者（学習用の仮想ユーザー）

### 1.2 スコープ

**含むもの（In Scope）：**
- 認証・認可システム（JWT、セッション管理、RBAC）
- 経費申請・承認ワークフロー（多段階承認、並列承認）
- 予算管理・監視システム
- ファイルアップロード・管理
- リアルタイム通知システム
- 監査ログ・イベントソーシング
- マイクロサービスアーキテクチャ
- BFFパターンによるAPI集約
- フロントエンド（Next.js）とバックエンド（Go）
- CI/CD パイプライン（GitHub Actions）
- IaC（Terraform）によるAWSインフラ構築

**含まないもの（Out of Scope）：**
- 本格的なOCR機能（外部API連携は将来拡張）
- 会計システム連携（インターフェースのみ実装）
- 電子帳簿保存法完全対応（学習用レベル）
- プロダクション運用レベルのセキュリティ
- マルチテナント機能
- 国際化（i18n）対応

## 2. 機能要件

### 2.1 ユーザーストーリー

#### 申請者として
```
As a 従業員
I want 経費申請を簡単に作成・提出できる
So that 業務効率が向上し、正確な経費管理ができる
```

#### 承認者として
```
As a 管理者・上司
I want 申請内容を効率的に確認・承認できる
So that 適切な経費管理と迅速な業務処理ができる
```

#### システム管理者として
```
As a システム管理者
I want ユーザー・組織・承認ルールを管理できる
So that 組織の変化に柔軟に対応できる
```

### 2.2 機能一覧

| 機能ID | 機能名 | 優先度 | 概要 | 学習ポイント |
|--------|--------|--------|------|-------------|
| **認証・認可系** |
| AUTH001 | ユーザー認証 | 高 | JWT認証、セッション管理 | JWT実装、セキュリティ |
| AUTH002 | 権限管理 | 高 | RBAC実装 | 認可パターン |
| AUTH003 | MFA | 中 | TOTP認証 | セキュリティ実装 |
| **経費管理系** |
| EXP001 | 経費申請CRUD | 高 | 申請の作成・読取・更新・削除 | DDD集約設計 |
| EXP002 | ファイルアップロード | 高 | 領収書画像・PDF管理 | ファイル処理 |
| EXP003 | 申請検索・集計 | 中 | 条件検索、統計情報 | 検索最適化 |
| EXP004 | テンプレート機能 | 低 | 申請テンプレート | 再利用性設計 |
| **ワークフロー系** |
| WF001 | 承認フロー定義 | 高 | 承認ルート・条件設定 | ワークフローエンジン |
| WF002 | 承認アクション | 高 | 承認・却下・差戻し | ステートマシン |
| WF003 | 代理承認 | 中 | 代理者設定・期間管理 | 委譲パターン |
| **予算管理系** |
| BUD001 | 予算設定・監視 | 中 | 予算設定、消化率監視 | リアルタイム計算 |
| BUD002 | 予算アラート | 中 | 閾値アラート | イベント駆動 |
| **通知系** |
| NOT001 | リアルタイム通知 | 高 | WebSocket通知 | リアルタイム通信 |
| NOT002 | メール通知 | 中 | SMTP連携 | 外部サービス連携 |
| **監査系** |
| AUD001 | 操作ログ | 高 | 全操作の記録 | イベントソーシング |
| AUD002 | データ変更履歴 | 中 | 変更追跡 | 監査証跡 |

### 2.3 API仕様概要

#### 認証サービス (auth-service)
```yaml
エンドポイント:
  POST /auth/login        # ログイン
  POST /auth/logout       # ログアウト
  POST /auth/refresh      # トークンリフレッシュ
  GET  /auth/profile      # プロフィール取得
  PUT  /auth/profile      # プロフィール更新
```

#### 経費サービス (expense-service)
```yaml
エンドポイント:
  GET    /expenses           # 申請一覧
  POST   /expenses           # 申請作成
  GET    /expenses/{id}      # 申請詳細
  PUT    /expenses/{id}      # 申請更新
  DELETE /expenses/{id}      # 申請削除
  POST   /expenses/{id}/files # ファイルアップロード
```

#### ワークフローサービス (workflow-service)
```yaml
エンドポイント:
  POST /workflows/{id}/approve  # 承認
  POST /workflows/{id}/reject   # 却下
  POST /workflows/{id}/return   # 差戻し
  GET  /workflows/pending       # 承認待ち一覧
```

#### BFFサービス (bff-service)
```yaml
機能:
  - 各マイクロサービスへのプロキシ
  - レスポンス集約・整形
  - WebSocket接続管理
  - ファイルアップロード処理
```

## 3. 非機能要件

### 3.1 性能要件（学習目的レベル）

- **レスポンス時間：** API応答500ms以内
- **スループット：** 100リクエスト/秒（負荷テスト実施）
- **同時接続数：** 50セッション

### 3.2 セキュリティ要件（学習レベル）

- **認証：** JWT（RS256）、セッション管理
- **認可：** RBAC実装
- **データ保護：** パスワードハッシュ化（bcrypt）
- **入力値検証：** 全APIエンドポイントで実施

### 3.3 可用性・信頼性（学習レベル）

- **稼働率：** 開発・学習時間中の安定稼働
- **障害対応：** ログ出力、基本的なエラーハンドリング

## 4. 技術要件

### 4.1 技術スタック方針

```yaml
バックエンド:
  言語: Go 1.21+
  フレームワーク: Gin, gRPC
  アーキテクチャ: クリーンアーキテクチャ + DDD
  データベース: PostgreSQL 15+
  キャッシュ: Redis
  メッセージング: Redis Pub/Sub (ローカル) → AWS SQS/SNS (AWS)

フロントエンド:
  フレームワーク: Next.js 14+ (App Router)
  言語: TypeScript
  状態管理: Zustand
  UIライブラリ: shadcn/ui + Tailwind CSS
  WebSocket: Socket.io Client

インフラ:
  コンテナ: Docker + Docker Compose (ローカル)
  オーケストレーション: AWS ECS (AWS環境)
  IaC: Terraform
  CI/CD: GitHub Actions
  監視: AWS CloudWatch

開発ツール:
  バージョン管理: Git + GitHub
  テスト: Go testing, Playwright (E2E)
  リンター: golangci-lint, ESLint
  フォーマッター: gofmt, Prettier
```

### 4.2 アーキテクチャ原則

```yaml
マイクロサービス:
  - 単一責任の原則
  - データベース per サービス（論理分離）
  - 非同期通信優先（イベント駆動）
  - サービス間の疎結合

クリーンアーキテクチャ:
  - 依存性逆転の原則
  - ドメインロジックの独立性
  - テスタビリティの確保

DDD実践:
  - 集約によるデータ整合性
  - ドメインイベント
  - ユビキタス言語
```

### 4.3 外部連携

```yaml
開発段階:
  - SMTP: ローカルMailhog
  - ファイルストレージ: ローカルディスク
  - 通知: WebSocket + コンソール出力

AWS段階:
  - メール: Amazon SES
  - ファイルストレージ: Amazon S3
  - 通知: AWS SNS
```

## 5. 制約・前提条件

### 5.1 技術的制約

- **学習期間：** 6ヶ月（ローカル3ヶ月 → AWS 3ヶ月）
- **開発環境：** macOS/Linux、Docker必須
- **AWSコスト：** Free Tier + $200クレジット内
- **言語制約：** Go（バックエンド）、TypeScript（フロントエンド）固定

### 5.2 運用制約

- **デプロイ：** GitHub Actions経由の自動デプロイ
- **監視：** 基本的なメトリクス取得（学習レベル）
- **バックアップ：** 日次スナップショット（AWS RDS）

## 6. 受け入れ条件

### 6.1 機能受け入れ条件

- [ ] 全API機能が仕様通り動作する
- [ ] フロントエンド全画面が実装され、API連携が完了している
- [ ] リアルタイム通知が正常に動作する
- [ ] ファイルアップロード・ダウンロードが正常に動作する
- [ ] 承認ワークフローが設定通り動作する
- [ ] 予算監視・アラートが正常に動作する

### 6.2 品質受け入れ条件

- [ ] バックエンドテストカバレッジ80%以上
- [ ] `make lint` エラー0件（Go、TypeScript両方）
- [ ] E2Eテストが主要フローで動作する
- [ ] 性能要件（レスポンス500ms以内）をクリアする
- [ ] セキュリティ基本要件を満たす

### 6.3 技術学習達成条件

- [ ] クリーンアーキテクチャの全レイヤーが実装されている
- [ ] DDDの戦術的パターン（集約、エンティティ、値オブジェクト）が適用されている
- [ ] マイクロサービス間通信（同期・非同期）が実装されている
- [ ] イベントソーシングパターンが監査機能で実装されている
- [ ] CI/CDパイプラインが完全自動化されている

## 7. テスト戦略

### 7.1 テスト種別

```yaml
ユニットテスト:
  対象: ドメインロジック、ユースケース
  フレームワーク: Go testing
  カバレッジ: 80%以上

統合テスト:
  対象: API層、データベース層
  方法: Testcontainersを使用したDB統合テスト

E2Eテスト:
  対象: 主要ユーザーフロー
  フレームワーク: Playwright
  シナリオ: ログイン → 申請作成 → 承認 → 完了
```

### 7.2 テストシナリオ概要

```yaml
正常系:
  - ユーザー登録 → ログイン → 申請作成 → 承認 → 完了
  - 複数段階承認フロー
  - ファイルアップロード → 表示

異常系:
  - 認証失敗（無効なトークン）
  - 権限不足（他人の申請を操作）
  - バリデーションエラー（不正な入力値）
  - 予算超過申請

境界値:
  - ファイルサイズ上限
  - 申請金額上限
  - 承認期限
```

## 8. 実装方針

### 8.1 開発アプローチ（学習最適化）

```yaml
Phase 1 (Month 1): 基盤構築
  目標: アーキテクチャパターンの理解
  成果物:
    - 認証サービス（クリーンアーキテクチャ）
    - BFF基盤（API集約）
    - フロントエンド基盤（Next.js + 認証）

Phase 2 (Month 2): コア機能
  目標: DDD実践、ワークフローパターン
  成果物:
    - 経費サービス（DDD集約設計）
    - ワークフローサービス（Sagaパターン）
    - リアルタイム通知（WebSocket）

Phase 3 (Month 3): 統合・完成
  目標: マイクロサービス統合、テスト
  成果物:
    - 予算・監査サービス
    - 統合テスト
    - パフォーマンス最適化

Phase 4-6 (Month 4-6): AWS移行
  目標: IaC、CI/CD、本番運用
  成果物:
    - Terraform完全自動化
    - Blue/Greenデプロイ
    - 監視・ログ基盤
```

### 8.2 既存コードとの関係

- **新規プロジェクト**として開始
- **後方互換性**は考慮不要
- **マイグレーション**は不要

### 8.3 学習リソース・参考実装

```yaml
技術書籍:
  - 「実践ドメイン駆動設計」
  - 「マイクロサービスパターン」
  - 「Clean Architecture」

参考実装:
  - Go Clean Architecture examples
  - Event Sourcing patterns
  - AWS Well-Architected Framework
```

## 9. 成功指標

### 9.1 技術習得指標

```yaml
アーキテクチャ理解:
  - クリーンアーキテクチャの依存性方向を説明できる
  - DDDの集約設計原則を適用できる
  - マイクロサービス間の通信パターンを実装できる

実装スキル:
  - Go言語でのWebAPI開発
  - TypeScriptでのSPA開発
  - Dockerによるコンテナ化
  - Terraformによるインフラ管理

運用スキル:
  - CI/CDパイプラインの構築・運用
  - AWSサービスの実践的利用
  - 監視・ログ分析の基礎
```

### 9.2 完成度指標

```yaml
機能完成度:
  - 全機能要件の実装完了: 100%
  - テストカバレッジ: 80%以上
  - パフォーマンス要件クリア: 100%

品質指標:
  - Lint エラー: 0件
  - セキュリティ基本要件: 100%充足
  - E2Eテスト: 主要フロー100%動作

学習成果:
  - 技術ブログ記事作成（各Phase完了時）
  - アーキテクチャ説明資料作成
  - 学習振り返りレポート作成
```

## 10. リスクと対策

### 10.1 技術的リスク

```yaml
マイクロサービス複雑性:
  リスク: サービス間通信の複雑化
  対策: 段階的分割、最初はモノリスから開始

パフォーマンス問題:
  リスク: N+1問題、レスポンス遅延
  対策: 早期プロファイリング、適切なキャッシュ戦略

AWSコスト超過:
  リスク: $200クレジット超過
  対策: 予算アラート設定、使用量の日次確認
```

### 10.2 学習リスク

```yaml
学習曲線の急峻さ:
  リスク: 新技術習得による遅延
  対策: 各技術のチュートリアル期間確保、MVP定義

機能過多による遅延:
  リスク: 学習範囲の広がりすぎ
  対策: 優先度付け、Phase分割での段階的実装

モチベーション維持:
  リスク: 長期プロジェクトでの集中力低下
  対策: 小さな成功体験の積み重ね、定期的な成果発表
```

---

この要件定義書は、**学習目的に最適化した包括的な経費精算システム**の実装を通じて、現代的なソフトウェア開発手法を実践的に学ぶためのガイドラインとして作成されています。